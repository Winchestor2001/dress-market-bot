<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Product List</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      background: #f5f5f5;
    }

    .product {
      display: flex;
      align-items: center;
      background: white;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 8px;
    }

    .product img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      margin-right: 1rem;
    }

    .product-title {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .product-title small {
      color: #666;
      font-size: 0.85em;
    }

    .product input[type="checkbox"] {
      margin-right: 1rem;
      transform: scale(1.3);
    }

    #delete-selected {
      display: none;
      width: 100%;
      padding: 0.75rem;
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 6px;
      margin-bottom: 1rem;
      cursor: pointer;
      font-size: 16px;
    }

    #delete-selected:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<h2>Продукты</h2>

<input
  type="text"
  id="search-input"
  placeholder="Поиск по названию..."
  style="width: 100%; padding: 0.5rem; margin-bottom: 1rem; border: 1px solid #ccc; border-radius: 4px;"
/>

<button id="delete-selected" disabled>Удалить выбранные</button>

<p id="product-count">Всего: ...</p>
<div id="product-list">Загрузка...</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  const tg = window.Telegram.WebApp;
  tg.expand();

  let allProducts = [];
  const container = document.getElementById('product-list');
  const searchInput = document.getElementById('search-input');
  const countElement = document.getElementById('product-count');
  const deleteSelectedBtn = document.getElementById('delete-selected');

  searchInput.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase();
    const filtered = allProducts.filter(p =>
      p.name.toLowerCase().includes(query)
    );
    renderProducts(filtered);
  });

  searchInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      searchInput.blur();
    }
  });

  deleteSelectedBtn.addEventListener('click', () => {
    const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');
    const selectedIds = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.id));

    const confirmed = confirm(`Удалить ${selectedIds.length} товар(а)?`);
    if (!confirmed) return;

    if (selectedIds.length === 0) {
      alert('Ничего не выбрано.');
      return;
    }

    tg.sendData(JSON.stringify({ action: 'delete_products', ids: selectedIds }));
  });

  async function loadProducts() {
    try {
      const response = await fetch('https://dress-market-bot-webapp.dizel.online/get-products');
      const products = await response.json();
      allProducts = products;
      renderProducts(products);
    } catch (error) {
      container.innerHTML = 'Ошибка загрузки продуктов';
      console.error(error);
    }
  }

  function renderProducts(products) {
    container.innerHTML = '';
    countElement.textContent = `Всего: ${products.length}`;
    deleteSelectedBtn.style.display = products.length > 0 ? 'block' : 'none';
    deleteSelectedBtn.disabled = true;

    products.forEach(product => {
      const div = document.createElement('div');
      div.className = 'product';

      div.innerHTML = `
        <input type="checkbox" class="product-checkbox" data-id="${product.id}" />
        <img src="${product.photo}" />
        <div class="product-title">
          <span>ID: ${product.id}</span><br/>
          <strong>${product.name}</strong><br/>
          <small>${product.description || ''}</small>
        </div>
      `;

      container.appendChild(div);
    });

    setupCheckboxListener();
  }

  function setupCheckboxListener() {
    const checkboxes = document.querySelectorAll('.product-checkbox');

    checkboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        const anyChecked = Array.from(checkboxes).some(c => c.checked);
        deleteSelectedBtn.disabled = !anyChecked;
      });
    });
  }

  loadProducts();
</script>
</body>
</html>
